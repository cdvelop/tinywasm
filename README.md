# tinywasm
<!-- START_SECTION:BADGES_SECTION -->
<a href="docs/img/badges.svg"><img src="docs/img/badges.svg" alt="Project Badges" title="Generated by badges.sh from github.com/cdvelop/devscripts"></a>
<!-- END_SECTION:BADGES_SECTION -->

Go package for intelligent WebAssembly compilation with automatic file detection and 3-mode compiler system.

## Features

- **3-Mode Compiler System**: Fast ("f"), Bugs ("b"), Minimal ("m")
- **DevTUI Integration**: FieldHandler interface for interactive mode switching
- Smart file detection via prefixes (frontend/backend separation)
- Triple compiler support: Go standard (fast dev), TinyGo debug (-opt=1), TinyGo production (-opt=z)
- VS Code auto-configuration for WASM development
- Single output: All files ‚Üí `main.wasm`

## Quick Start

```go
// Basic usage
config := tinywasm.NewConfig() // Pre-configured with defaults
config.WebFilesRootRelative = "web"
config.WebFilesSubRelative = "public"

tw := tinywasm.New(config)
tw.NewFileEvent("web/main.wasm.go", ".go", "web/main.wasm.go", "write")

// DevTUI Integration - 3 Mode System
fmt.Println("Current mode:", tw.Value())    // "f" (coding)
msg, err := tw.Change("b")                  // Switch to debug mode
fmt.Println("Status:", msg)                 // "Switching to debugging mode"

// Advanced configuration
config := &tinywasm.Config{
    WebFilesRootRelative: "web",
    WebFilesSubRelative:  "public",
    BuildFastShortcut:      "f",  // Customizable shortcuts
    BuildBugShortcut:   "b",
    BuildMinimalShortcut:  "m",
}
```


## DevTUI FieldHandler Interface

TinyWasm implements the DevTUI FieldHandler interface for interactive development:

```go
// DevTUI Integration
label := tw.Label()           // "Compiler Mode"
current := tw.Value()         // Current mode shortcut ("f", "b", "m")
canEdit := tw.Editable()      // true
timeout := tw.Timeout()       // 0 (no timeout)

// Interactive mode change with validation
msg, err := tw.Change("b")
if err != nil {
    // Handle validation errors (invalid mode, missing TinyGo, etc.)
}
// msg contains success message or warning if auto-compilation fails
```

## VS Code Integration

Auto-creates `.vscode/settings.json` with WASM environment:
```json
{"gopls": {"env": {"GOOS": "js", "GOARCH": "wasm"}}}
```

## API

**Core:**
- `New(config *Config) *TinyWasm`
- `NewConfig() *Config` - Pre-configured with sensible defaults
- `NewFileEvent(fileName, ext, path, event string) error`
- `ShouldCompileToWasm(fileName, path string) bool`

**DevTUI FieldHandler Interface:**
- `Label() string` - Returns "Compiler Mode"
- `Value() string` - Current mode shortcut ("f", "b", "m")
- `Editable() bool` - Returns true (field is editable)
- `Change(newValue any) (string, error)` - Switch compiler mode with validation
- `Timeout() time.Duration` - Returns 0 (no timeout)

**Legacy Compiler Methods (deprecated):**
- `TinyGoCompiler() bool` - Use `Value()` instead
- `SetTinyGoCompiler(bool) error` - Use `Change()` instead
- `VerifyTinyGoInstallation() error`

**Utils:**
- `MainInputFileRelativePath() string`
- `UnobservedFiles() []string`
- `JavascriptForInitializing() (string, error)`

## Config

```go
type Config struct {
	AppRootDir                  string        // application root directory (absolute), defaults to "."
	WebFilesRootRelative        string        // root web folder (relative) eg: "web"
	WebFilesSubRelative         string        // subfolder under root (relative) eg: "public"
	WebFilesSubRelativeJsOutput string        // output path for js files (relative) eg: "theme/js"
	MainInputFile               string        // main input file for WASM compilation (default: "main.wasm.go")
	Logger                      func(message ...any) // For logging output to external systems (e.g., TUI, console)
	// NOTE: `TinyGoCompiler` was removed from the public `Config` to avoid
	// confusion. The compiler selection is controlled at runtime via the
	// TinyWasm instance. Use `tw.Change("f"|"b"|"m")` to switch modes and
	// `tw.Value()` to inspect the current mode. The internal boolean
	// `tinyGoCompiler` remains a private implementation detail.

	// NEW: Shortcut configuration (default: "f", "b", "m")
	BuildFastShortcut     string // coding "f" (fast) compile fast with go
	BuildBugShortcut  string // debugging "b" (bugs) compile with tinygo debug
	BuildMinimalShortcut string // production "m" (minimal) compile with tinygo minimal binary size

	// gobuild integration fields
	Callback           func(error)     // Optional callback for async compilation
	CompilingArguments func() []string // Build arguments for compilation (e.g., ldflags)

}

// Pre-configured constructor (recommended)
func NewConfig() *Config
```

## Mode Switching
```go
tw.Change("m")  // production mode with TinyGo -opt=z
tw.Change("b")  // debug mode with TinyGo -opt=1
tw.Change("f")  // coding mode with Go standard
```

## Requirements

- Go 1.20+
- TinyGo (optional, required for debug/production modes)
- DevTUI (optional, for interactive development)

## Migration Guide

**From TinyWasm v1.x:**

| Old API | New API | Notes |
|---------|---------|-------|
| `SetTinyGoCompiler(true)` | `Change("m")` | Production mode |
| `SetTinyGoCompiler(false)` | `Change("f")` | Coding mode |
| `TinyGoCompiler()` | `Value() == "m" \|\| Value() == "b"` | Check if using TinyGo |
| `config.Log` | `config.Writer` | Field renamed |

**Benefits:**
- üéØ **3 optimized modes** instead of binary choice
- üîß **DevTUI integration** for interactive development  
- üì¶ **Smaller debug builds** with TinyGo -opt=1
- ‚ö° **Auto-recompilation** on mode switch
- üõ†Ô∏è **Better error handling** with validation


## [Contributing](https://github.com/cdvelop/cdvelop/blob/main/CONTRIBUTING.md)